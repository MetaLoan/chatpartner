# 项目结构规划

## 目录结构

```
aibot/
├── backend/                    # 后端代码
│   ├── app/
│   │   ├── __init__.py
│   │   ├── main.py            # FastAPI主应用
│   │   ├── config.py           # 配置管理
│   │   ├── database.py         # 数据库连接
│   │   │
│   │   ├── models/             # 数据模型
│   │   │   ├── account.py
│   │   │   ├── group.py
│   │   │   ├── message.py
│   │   │   ├── config.py
│   │   │   └── ...
│   │   │
│   │   ├── schemas/            # Pydantic模型
│   │   │   ├── account.py
│   │   │   ├── group.py
│   │   │   └── ...
│   │   │
│   │   ├── api/                # API路由
│   │   │   ├── __init__.py
│   │   │   ├── accounts.py
│   │   │   ├── groups.py
│   │   │   ├── messages.py
│   │   │   ├── statistics.py
│   │   │   └── configs.py
│   │   │
│   │   ├── services/           # 业务逻辑
│   │   │   ├── account_service.py
│   │   │   ├── group_service.py
│   │   │   ├── message_service.py
│   │   │   ├── ai_service.py
│   │   │   ├── telegram_service.py
│   │   │   └── statistics_service.py
│   │   │
│   │   ├── workers/            # 后台任务
│   │   │   ├── message_worker.py
│   │   │   ├── reply_worker.py
│   │   │   ├── scheduled_task_worker.py
│   │   │   └── statistics_worker.py
│   │   │
│   │   ├── utils/              # 工具函数
│   │   │   ├── ai_utils.py
│   │   │   ├── telegram_utils.py
│   │   │   ├── content_filter.py
│   │   │   ├── sentiment_analyzer.py
│   │   │   └── topic_detector.py
│   │   │
│   │   └── middleware/         # 中间件
│   │       ├── auth.py
│   │       └── logging.py
│   │
│   ├── alembic/                # 数据库迁移
│   ├── tests/                  # 测试代码
│   ├── requirements.txt
│   └── Dockerfile
│
├── frontend/                    # 前端代码
│   ├── src/
│   │   ├── components/         # 组件
│   │   │   ├── Dashboard/
│   │   │   ├── AccountManagement/
│   │   │   ├── GroupManagement/
│   │   │   ├── MessageHistory/
│   │   │   └── Statistics/
│   │   │
│   │   ├── pages/              # 页面
│   │   │   ├── Dashboard.tsx
│   │   │   ├── Accounts.tsx
│   │   │   ├── Groups.tsx
│   │   │   └── ...
│   │   │
│   │   ├── services/           # API服务
│   │   │   └── api.ts
│   │   │
│   │   ├── store/              # 状态管理
│   │   │   └── index.ts
│   │   │
│   │   ├── utils/              # 工具函数
│   │   └── App.tsx
│   │
│   ├── package.json
│   └── Dockerfile
│
├── telegram_clients/            # Telegram客户端管理
│   ├── client_manager.py       # 客户端管理器
│   ├── message_handler.py      # 消息处理器
│   └── session_manager.py       # 会话管理器
│
├── ai_services/                 # AI服务封装
│   ├── openai_service.py
│   ├── prompt_manager.py
│   └── model_config.py
│
├── data/                        # 数据目录
│   ├── sessions/                # Telegram会话文件
│   ├── exports/                 # 导出文件
│   └── logs/                    # 日志文件
│
├── docs/                        # 文档
│   ├── API文档.md
│   ├── 部署文档.md
│   └── 开发文档.md
│
├── scripts/                     # 脚本
│   ├── init_db.py
│   ├── migrate.py
│   └── backup.py
│
├── docker-compose.yml           # Docker编排
├── .env.example                 # 环境变量示例
├── .gitignore
├── README.md
└── 需求文档.md
```

## 数据库设计（概要）

### 核心表结构

```sql
-- AI账号表
CREATE TABLE ai_accounts (
    id SERIAL PRIMARY KEY,
    phone_number VARCHAR(20) UNIQUE,
    api_id INTEGER,
    api_hash VARCHAR(100),
    session_file VARCHAR(255),
    nickname VARCHAR(100),
    status VARCHAR(20),  -- online/offline/error
    priority INTEGER DEFAULT 5,
    ai_api_key VARCHAR(255),
    ai_model VARCHAR(50) DEFAULT 'gpt-4o-mini',
    system_prompt TEXT,
    reply_interval INTEGER DEFAULT 60,
    tone VARCHAR(50),
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- 群组表
CREATE TABLE groups (
    id SERIAL PRIMARY KEY,
    chat_id BIGINT UNIQUE,
    username VARCHAR(100),
    title VARCHAR(255),
    type VARCHAR(20),  -- group/supergroup/channel
    status VARCHAR(20),  -- active/inactive
    language VARCHAR(10),
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- 账号-群组关联表
CREATE TABLE account_groups (
    id SERIAL PRIMARY KEY,
    account_id INTEGER REFERENCES ai_accounts(id),
    group_id INTEGER REFERENCES groups(id),
    priority INTEGER DEFAULT 5,
    reply_probability FLOAT DEFAULT 0.3,
    active_hours JSONB,  -- 活跃时间段
    enabled BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP,
    UNIQUE(account_id, group_id)
);

-- 发言记录表
CREATE TABLE messages (
    id SERIAL PRIMARY KEY,
    account_id INTEGER REFERENCES ai_accounts(id),
    group_id INTEGER REFERENCES groups(id),
    message_id BIGINT,
    content TEXT,
    reply_to_message_id BIGINT,
    topic VARCHAR(255),
    sentiment VARCHAR(20),
    created_at TIMESTAMP,
    INDEX idx_account_group_time (account_id, group_id, created_at)
);

-- 配置表
CREATE TABLE configurations (
    id SERIAL PRIMARY KEY,
    account_id INTEGER REFERENCES ai_accounts(id),
    key VARCHAR(100),
    value TEXT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    UNIQUE(account_id, key)
);

-- 定时任务表
CREATE TABLE scheduled_tasks (
    id SERIAL PRIMARY KEY,
    account_id INTEGER REFERENCES ai_accounts(id),
    group_id INTEGER REFERENCES groups(id),
    task_type VARCHAR(50),
    content TEXT,
    schedule_time TIMESTAMP,
    repeat_type VARCHAR(20),  -- once/daily/weekly
    enabled BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP
);

-- 黑名单表
CREATE TABLE blacklists (
    id SERIAL PRIMARY KEY,
    account_id INTEGER REFERENCES ai_accounts(id),
    target_type VARCHAR(20),  -- user/group
    target_id BIGINT,
    reason VARCHAR(255),
    created_at TIMESTAMP,
    UNIQUE(account_id, target_type, target_id)
);

-- 统计报表表
CREATE TABLE reports (
    id SERIAL PRIMARY KEY,
    report_type VARCHAR(50),
    account_id INTEGER REFERENCES ai_accounts(id),
    group_id INTEGER REFERENCES groups(id),
    period_start TIMESTAMP,
    period_end TIMESTAMP,
    data JSONB,
    created_at TIMESTAMP
);

-- 活跃时间周期表（账号级别）
CREATE TABLE account_active_periods (
    id SERIAL PRIMARY KEY,
    account_id INTEGER REFERENCES ai_accounts(id) ON DELETE CASCADE,
    period_type VARCHAR(20),  -- weekly/date_range/time_slot
    day_of_week INTEGER[],  -- 0-6 (Monday-Sunday), 用于weekly类型
    date_start DATE,  -- 用于date_range类型
    date_end DATE,  -- 用于date_range类型
    time_start TIME,  -- 用于time_slot类型
    time_end TIME,  -- 用于time_slot类型
    timezone VARCHAR(50) DEFAULT 'UTC',
    enabled BOOLEAN DEFAULT TRUE,
    priority INTEGER DEFAULT 0,  -- 多个时间段时的优先级
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    UNIQUE(account_id, period_type, day_of_week, time_start, time_end)
);

-- 全局活跃时间周期表
CREATE TABLE global_active_periods (
    id SERIAL PRIMARY KEY,
    period_type VARCHAR(20),  -- weekly/date_range/time_slot
    day_of_week INTEGER[],  -- 0-6 (Monday-Sunday), 用于weekly类型
    date_start DATE,  -- 用于date_range类型
    date_end DATE,  -- 用于date_range类型
    time_start TIME,  -- 用于time_slot类型
    time_end TIME,  -- 用于time_slot类型
    timezone VARCHAR(50) DEFAULT 'UTC',
    enabled BOOLEAN DEFAULT TRUE,
    priority INTEGER DEFAULT 0,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

-- 全局主线提示词表
CREATE TABLE global_main_prompts (
    id SERIAL PRIMARY KEY,
    version INTEGER DEFAULT 1,
    content TEXT NOT NULL,
    description VARCHAR(500),
    enabled BOOLEAN DEFAULT TRUE,
    created_by INTEGER,  -- 创建者用户ID
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    INDEX idx_version (version)
);

-- 账号提示词配置表
CREATE TABLE account_prompt_configs (
    id SERIAL PRIMARY KEY,
    account_id INTEGER REFERENCES ai_accounts(id) ON DELETE CASCADE,
    use_global_main_prompt BOOLEAN DEFAULT TRUE,
    combine_mode VARCHAR(20) DEFAULT 'framework',  -- framework/overlay/override
    account_prompt TEXT,  -- 账号独立提示词
    combined_prompt TEXT,  -- 组合后的完整提示词（缓存）
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    UNIQUE(account_id)
);

-- 全局主线提示词表
CREATE TABLE global_main_prompts (
    id SERIAL PRIMARY KEY,
    version INTEGER DEFAULT 1,
    content TEXT NOT NULL,
    description VARCHAR(500),
    enabled BOOLEAN DEFAULT TRUE,
    created_by INTEGER,  -- 创建者用户ID
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    INDEX idx_version (version)
);

-- 账号提示词配置表
CREATE TABLE account_prompt_configs (
    id SERIAL PRIMARY KEY,
    account_id INTEGER REFERENCES ai_accounts(id) ON DELETE CASCADE,
    use_global_main_prompt BOOLEAN DEFAULT TRUE,
    combine_mode VARCHAR(20) DEFAULT 'framework',  -- framework/overlay/override
    account_prompt TEXT,  -- 账号独立提示词
    combined_prompt TEXT,  -- 组合后的完整提示词（缓存）
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    UNIQUE(account_id)
);
```

## 技术选型建议

### 后端
- **框架**: FastAPI (高性能、异步支持)
- **ORM**: SQLAlchemy
- **数据库**: PostgreSQL
- **任务队列**: Celery + Redis
- **WebSocket**: FastAPI WebSocket

### 前端
- **框架**: React + TypeScript
- **UI库**: Ant Design / Material-UI
- **状态管理**: Redux Toolkit
- **图表**: ECharts / Chart.js
- **实时通信**: Socket.io-client

### 其他
- **容器化**: Docker + Docker Compose
- **CI/CD**: GitHub Actions
- **监控**: Prometheus + Grafana
- **日志**: ELK Stack (可选)

