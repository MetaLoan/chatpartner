# 全局主线提示词功能说明

## 功能概述

全局主线提示词是控制整体群营销聊天框架的核心配置，它定义了所有AI账号在群组中的整体发言策略、品牌调性、核心话题方向等。所有AI账号的发言都会遵循这个主线提示词设定的框架，确保营销活动的一致性和策略性。

## 功能特性

### 1. 核心作用

#### 1.1 统一营销策略
- 确保所有AI账号遵循统一的营销策略
- 保持品牌调性的一致性
- 统一核心话题和讨论方向

#### 1.2 聊天框架控制
- 定义整体聊天框架和边界
- 设定营销目标和重点
- 控制话题范围和深度

#### 1.3 策略调整
- 快速调整整体营销策略
- 无需逐个修改账号配置
- 支持A/B测试不同策略

### 2. 提示词组合模式

#### 2.1 框架模式（Framework Mode）⭐推荐
- **描述**: 主线提示词作为整体框架，账号提示词在框架内填充个性化细节
- **应用场景**: 需要统一策略但允许个性化表达
- **示例**:
  ```
  主线提示词: "你是一个专业的加密货币投资顾问，专注于DeFi和NFT领域..."
  账号提示词: "你的名字是小明，说话风格轻松幽默..."
  组合结果: 在专业投资顾问框架内，以轻松幽默的方式表达
  ```

#### 2.2 叠加模式（Overlay Mode）
- **描述**: 主线提示词和账号提示词叠加，共同作用
- **应用场景**: 需要同时强调策略和个性化
- **示例**:
  ```
  主线提示词: "强调产品的安全性和可靠性..."
  账号提示词: "使用数据和技术细节来支持观点..."
  组合结果: 用数据和技术细节来强调产品的安全性和可靠性
  ```

#### 2.3 覆盖模式（Override Mode）
- **描述**: 账号提示词完全覆盖主线提示词
- **应用场景**: 特殊账号需要完全独立的策略
- **示例**:
  ```
  主线提示词: "专注于产品推广..."
  账号提示词: "你是一个技术专家，只讨论技术问题，不涉及营销..."
  组合结果: 只讨论技术问题，不涉及营销（完全忽略主线提示词）
  ```

### 3. 版本管理

#### 3.1 版本控制
- 每次修改主线提示词自动创建新版本
- 保留所有历史版本
- 支持版本对比和查看

#### 3.2 版本回滚
- 支持回滚到任意历史版本
- 一键恢复之前的策略
- 支持版本备注和说明

#### 3.3 版本应用
- 可以指定版本应用到账号
- 支持不同账号使用不同版本（A/B测试）
- 版本切换平滑过渡

### 4. 应用范围

#### 4.1 全局应用
- 应用到所有AI账号
- 一键更新所有账号的策略
- 支持批量应用

#### 4.2 分组应用
- 应用到指定账号组
- 不同账号组可以使用不同策略
- 支持策略分组管理

#### 4.3 账号级应用
- 单个账号可以选择是否使用主线提示词
- 账号可以设置组合模式
- 支持账号独立策略

## 使用场景

### 场景1：品牌营销活动
```
主线提示词: "我们正在推广新的DeFi产品，强调其高收益和低风险特性。
所有发言应该围绕产品优势展开，避免负面话题。"
```
- 所有账号统一推广新产品
- 保持一致的营销信息
- 控制讨论方向

### 场景2：话题引导
```
主线提示词: "当前讨论重点应该围绕'Web3未来趋势'展开，
引导群成员讨论区块链技术发展、去中心化应用等话题。"
```
- 引导群内讨论方向
- 确保话题相关性
- 提升讨论质量

### 场景3：危机管理
```
主线提示词: "当前需要谨慎处理负面信息，所有回复应该：
1. 承认问题但不夸大
2. 提供解决方案
3. 引导正面讨论"
```
- 快速调整整体策略
- 统一应对危机
- 保护品牌形象

### 场景4：A/B测试
```
版本1: "强调产品创新性..."
版本2: "强调产品实用性..."
```
- 不同账号组使用不同版本
- 对比效果
- 优化策略

## 前端界面设计

### 1. 系统设置页面 - 主线提示词配置

#### 1.1 提示词编辑器
- **富文本编辑器**: 支持格式化文本
- **模板库**: 预设的提示词模板
- **变量支持**: 支持动态变量（如：{产品名}、{品牌名}）
- **实时预览**: 预览提示词效果
- **字数统计**: 显示提示词长度

#### 1.2 版本管理界面
- **版本列表**: 显示所有历史版本
- **版本对比**: 对比不同版本的差异
- **版本详情**: 查看版本创建时间、创建者、备注
- **回滚功能**: 一键回滚到指定版本

#### 1.3 应用配置
- **应用范围选择**: 全部账号/指定账号组/单个账号
- **组合模式选择**: 框架/叠加/覆盖
- **应用按钮**: 一键应用到选定账号
- **应用状态**: 显示应用进度和结果

### 2. 账号管理页面 - 提示词配置

#### 2.1 提示词组合预览
- **主线提示词预览**: 显示当前全局主线提示词
- **账号提示词编辑**: 编辑账号独立提示词
- **组合模式选择**: 选择组合模式
- **组合结果预览**: 实时预览组合后的完整提示词

#### 2.2 提示词测试
- **测试功能**: 输入测试消息，查看AI回复
- **效果对比**: 对比不同组合模式的效果
- **保存配置**: 保存当前配置

## 后端实现要点

### 1. 数据模型

```python
class GlobalMainPrompt(Base):
    id: int
    version: int
    content: str  # 提示词内容
    description: str  # 描述和备注
    enabled: bool
    created_by: int  # 创建者用户ID
    created_at: datetime
    updated_at: datetime

class AccountPromptConfig(Base):
    id: int
    account_id: int
    use_global_main_prompt: bool  # 是否使用全局主线提示词
    combine_mode: str  # framework/overlay/override
    account_prompt: str  # 账号独立提示词
    combined_prompt: str  # 组合后的完整提示词（缓存）
    created_at: datetime
    updated_at: datetime
```

### 2. 提示词组合逻辑

```python
def combine_prompts(global_prompt: str, account_prompt: str, mode: str) -> str:
    """
    组合全局主线提示词和账号提示词
    
    Args:
        global_prompt: 全局主线提示词
        account_prompt: 账号独立提示词
        mode: 组合模式 (framework/overlay/override)
    
    Returns:
        组合后的完整提示词
    """
    if mode == 'override':
        # 覆盖模式：完全使用账号提示词
        return account_prompt
    
    elif mode == 'framework':
        # 框架模式：主线提示词作为框架
        return f"""{global_prompt}

在这个框架内，你的个性化特征：
{account_prompt}"""
    
    elif mode == 'overlay':
        # 叠加模式：两者叠加
        return f"""{global_prompt}

同时，请注意以下个性化要求：
{account_prompt}"""
    
    else:
        # 默认：仅使用全局提示词
        return global_prompt
```

### 3. AI回复生成集成

```python
async def generate_ai_response(account_id: int, message_text: str) -> str:
    """
    生成AI回复，应用组合后的提示词
    """
    # 1. 获取账号提示词配置
    prompt_config = get_account_prompt_config(account_id)
    
    # 2. 组合提示词
    if prompt_config.use_global_main_prompt:
        global_prompt = get_global_main_prompt()
        system_prompt = combine_prompts(
            global_prompt.content,
            prompt_config.account_prompt,
            prompt_config.combine_mode
        )
    else:
        system_prompt = prompt_config.account_prompt
    
    # 3. 调用AI API
    response = await openai_client.chat.completions.create(
        model=model,
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": message_text}
        ]
    )
    
    return response.choices[0].message.content
```

### 4. 版本管理

```python
def create_new_version(content: str, description: str, user_id: int) -> GlobalMainPrompt:
    """
    创建新版本的主线提示词
    """
    # 获取当前最新版本号
    latest_version = get_latest_version()
    
    # 创建新版本
    new_version = GlobalMainPrompt(
        version=latest_version + 1,
        content=content,
        description=description,
        enabled=True,
        created_by=user_id
    )
    
    return save(new_version)

def rollback_to_version(version: int) -> bool:
    """
    回滚到指定版本
    """
    target_version = get_version(version)
    if not target_version:
        return False
    
    # 创建新版本，使用目标版本的内容
    create_new_version(
        content=target_version.content,
        description=f"回滚到版本 {version}",
        user_id=current_user_id()
    )
    
    return True
```

### 5. API接口

```python
# 获取全局主线提示词
GET /api/configs/global-main-prompt
Response: {
    "id": 1,
    "version": 3,
    "content": "...",
    "description": "...",
    "enabled": true,
    "created_at": "..."
}

# 更新全局主线提示词
PUT /api/configs/global-main-prompt
Request: {
    "content": "...",
    "description": "..."
}
Response: {
    "id": 1,
    "version": 4,  # 自动递增
    ...
}

# 获取版本历史
GET /api/configs/global-main-prompt/versions
Response: {
    "versions": [
        {"version": 4, "content": "...", "created_at": "..."},
        {"version": 3, "content": "...", "created_at": "..."},
        ...
    ]
}

# 回滚到指定版本
POST /api/configs/global-main-prompt/rollback
Request: {
    "version": 3
}

# 预览提示词效果
POST /api/configs/global-main-prompt/preview
Request: {
    "content": "...",
    "test_message": "你好"
}
Response: {
    "preview_response": "AI生成的回复预览"
}

# 应用主线提示词
POST /api/configs/global-main-prompt/apply
Request: {
    "account_ids": [1, 2, 3],  # 空数组表示应用到所有账号
    "combine_mode": "framework"
}

# 获取账号组合后的完整提示词
GET /api/accounts/{id}/prompt-combined
Response: {
    "global_prompt": "...",
    "account_prompt": "...",
    "combine_mode": "framework",
    "combined_prompt": "..."
}
```

## 配置示例

### 示例1：DeFi产品推广
```
全局主线提示词:
"你是一个专业的DeFi投资顾问，正在推广我们的新DeFi产品。
核心策略：
1. 强调产品的高收益特性（年化收益率15-20%）
2. 突出产品的安全性（已通过安全审计）
3. 引导用户了解产品详情
4. 避免讨论竞争对手的负面信息
5. 保持专业和友好的语调

所有发言都应该围绕产品优势展开，自然引导话题到产品介绍。"
```

### 示例2：技术讨论引导
```
全局主线提示词:
"当前群组的讨论重点应该围绕'Web3技术发展'展开。

讨论方向：
- 区块链技术的最新进展
- DeFi协议的技术创新
- NFT的技术应用
- 去中心化存储方案

引导策略：
1. 当有人提到相关技术话题时，深入讨论
2. 分享最新的技术资讯和观点
3. 鼓励技术交流和知识分享
4. 避免纯粹的营销内容"
```

### 示例3：危机应对
```
全局主线提示词:
"当前需要谨慎处理负面信息和质疑。

应对策略：
1. 承认问题但不夸大其严重性
2. 提供具体的解决方案
3. 用数据和事实支持观点
4. 引导讨论到正面方向
5. 保持冷静和专业

禁止行为：
- 与用户争论
- 回避问题
- 使用攻击性语言"
```

## 最佳实践

### 1. 提示词编写
- **明确目标**: 清楚定义营销目标和策略
- **具体指导**: 提供具体的发言指导，而非抽象概念
- **边界设定**: 明确什么可以说，什么不能说
- **风格统一**: 保持整体风格的一致性

### 2. 版本管理
- **重大变更**: 创建新版本而非直接修改
- **版本说明**: 每次更新都添加清晰的说明
- **测试验证**: 新版本先在测试账号验证
- **逐步推广**: 逐步应用到所有账号

### 3. 组合策略
- **框架模式**: 大多数账号使用框架模式
- **特殊账号**: 特殊需求的账号使用覆盖模式
- **A/B测试**: 使用不同组合模式进行测试

### 4. 监控优化
- **效果监控**: 监控发言效果和用户反馈
- **策略调整**: 根据数据调整策略
- **持续优化**: 不断优化提示词内容

## 注意事项

### 1. 提示词长度
- 主线提示词建议控制在500-1000字
- 过长可能导致AI理解偏差
- 过短可能无法提供足够指导

### 2. 组合效果
- 不同组合模式会产生不同效果
- 需要测试找到最佳组合
- 注意账号提示词与主线提示词的冲突

### 3. 版本管理
- 保留重要版本的备份
- 记录每次变更的原因
- 定期清理旧版本（可选）

### 4. 性能考虑
- 组合提示词可以缓存
- 避免频繁更新导致缓存失效
- 批量更新时考虑性能影响

