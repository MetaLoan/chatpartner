// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id          Int      @id @default(autoincrement())
  phoneNumber String   @unique
  aiApiKey    String?
  aiApiBaseUrl String?
  nickname    String?
  status      String   @default("offline") // online, offline, authenticating, error
  sessionPath String?
  lastLoginAt DateTime?
  
  // AI 设置
  aiModel       String @default("gpt-4o-mini")
  systemPrompt  String @default("你是币圈老韭菜，说话简短口语化，像微信聊天。禁止用感叹号，禁止说教，禁止营销腔。")
  replyInterval Int    @default(60)  // 秒
  listenInterval Int   @default(5)   // 秒
  bufferSize    Int    @default(10)  // 缓冲消息数
  autoReply     Boolean @default(true)
  replyProbability Int @default(100) // 0-100
  splitByNewline Boolean @default(true)
  multiMsgInterval Int @default(5)  // 秒
  enableImageRecognition Boolean @default(false)
  
  // 关联的目标群组
  targetGroupId Int?
  targetGroup   Group? @relation(fields: [targetGroupId], references: [id])
  
  // ========== 公共信息池配置 (v2.0新增) ==========
  // 是否启用主动发言功能
  proactiveEnabled Boolean @default(false)
  // 主动发言的时间间隔范围（秒）
  proactiveIntervalMin Int @default(300)  // 最小间隔5分钟
  proactiveIntervalMax Int @default(600)  // 最大间隔10分钟
  // 处理公共池信息的专用提示词
  proactivePrompt String @default("根据这条消息说两句，像发微信一样简短，不要超过15个字，禁止感叹号。")
  // 上次主动发言时间
  lastProactiveAt DateTime?
  
  priority    Int      @default(5)
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  messages    Message[]
  infoUsages  InfoItemUsage[]
}

model Group {
  id          Int      @id @default(autoincrement())
  telegramId  String   @unique
  name        String
  description String?
  memberCount Int      @default(0)
  isActive    Boolean  @default(true)
  language    String   @default("zh-CN") // 群组语言设置（zh-CN, en-US 等）
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  messages    Message[]
  accounts    Account[]
}

model Message {
  id        Int      @id @default(autoincrement())
  content   String
  accountId Int
  groupId   Int
  createdAt DateTime @default(now())

  account   Account  @relation(fields: [accountId], references: [id])
  group     Group    @relation(fields: [groupId], references: [id])
}

model Config {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ========== AI账号配置预设模板 ==========
model AccountTemplate {
  id          Int      @id @default(autoincrement())
  name        String   @unique  // 模板名称
  description String?  // 模板描述
  
  // AI API 设置
  aiApiKey      String?  // AI API Key
  aiApiBaseUrl  String?  // AI API 地址
  
  // AI 设置
  aiModel       String @default("gpt-4o-mini")
  systemPrompt  String @default("你是币圈老韭菜，说话简短口语化，像微信聊天。禁止用感叹号，禁止说教，禁止营销腔。")
  replyInterval Int    @default(60)
  listenInterval Int   @default(5)
  bufferSize    Int    @default(10)
  autoReply     Boolean @default(true)
  replyProbability Int @default(100)
  splitByNewline Boolean @default(true)
  multiMsgInterval Int @default(5)
  enableImageRecognition Boolean @default(false)
  
  // 主动发言设置
  proactiveEnabled Boolean @default(false)
  proactiveIntervalMin Int @default(300)
  proactiveIntervalMax Int @default(600)
  proactivePrompt String @default("根据这条消息说两句，像发微信一样简短，不要超过15个字，禁止感叹号。")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ========== 公共信息池相关模型 (v2.0新增) ==========

// 信息源类型枚举
// rss - RSS订阅
// btc_price - BTC市场价
// eth_price - ETH市场价
// manual_text - 管理员手动文字
// manual_image - 管理员手动图片
// contract_image - 晒单图（定时从API拉取）

// 信息源配置
model InfoSource {
  id          Int      @id @default(autoincrement())
  type        String   // rss, btc_price, eth_price, manual_text, manual_image, contract_image
  name        String   // 显示名称
  
  // RSS 专用配置
  rssUrl      String?  // RSS订阅地址
  
  // 价格获取专用配置
  priceApiUrl String?  // 价格API地址
  
  // 晒单图专用配置
  apiUrl      String?  // 晒单图API接口地址
  tradepair   String?  // 交易对（如 ETHUSDT、BTCUSDT）
  leverageOptions String?  // 杠杆倍数选项（JSON数组，如 [50, 100]）
  openTimeRangeHours Int?  // 开单时间范围（最近xx小时内的随机时间）
  cleanupHours Int?   // 自动清理时间（超过xx小时的数据自动删除）
  
  fetchInterval Int    @default(300) // 获取间隔（秒）
  
  // 工作方式: forward=直接转发, comment=输出观点
  workMode    String   @default("comment")
  
  // 是否可复用（被使用后其他账号是否还能用）
  reusable    Boolean  @default(false)
  
  // 是否允许同一账号反复引用同一内容
  allowSameAccountReuse Boolean @default(false)
  
  // 过期时间（小时），0表示不过期
  expireHours Int      @default(24)
  
  // 是否启用
  enabled     Boolean  @default(true)
  
  // 上次拉取时间
  lastFetchAt DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  items       InfoItem[]
}

// 信息条目
model InfoItem {
  id          Int      @id @default(autoincrement())
  sourceId    Int
  source      InfoSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  
  // 内容类型: text, image, price
  contentType String   @default("text")
  
  // 文本内容
  title       String?
  content     String?
  
  // 图片路径（如果是图片类型）
  imagePath   String?
  
  // 原始链接（RSS条目）
  sourceUrl   String?
  
  // 价格数据（如果是价格类型）
  priceValue  Float?
  priceChange Float?   // 24h涨跌幅
  
  // 外部唯一标识（用于RSS去重）
  externalId  String?
  
  // 发布时间（原始内容的时间）
  publishedAt DateTime?
  
  // 是否已过期
  expired     Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  usages      InfoItemUsage[]
  
  @@unique([sourceId, externalId])
}

// 信息使用记录
model InfoItemUsage {
  id        Int      @id @default(autoincrement())
  itemId    Int
  item      InfoItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  accountId Int
  account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  // 使用时间
  usedAt    DateTime @default(now())
  
  // 实际发送的内容（可能是转发或AI生成的评论）
  sentContent String?
  
  @@unique([itemId, accountId])
}
