# 配置热更新说明

本系统已支持大部分配置的**热更新**，无需重启服务即可生效。

## ✅ 已支持热更新的配置

### 1. 账号配置（Account）
**位置**：数据库 `Account` 表  
**更新方式**：前端修改后立即生效  
**实现机制**：
- 被动回复：每次 `processCurrentChat()` 前调用 `reloadAccountConfig()`
- 主动发言：每次 `executeProactive()` 时重新从数据库加载

**支持热更新的字段**：
- ✅ `systemPrompt` - 系统提示词（补充提示词）
- ✅ `aiModel` - AI 模型
- ✅ `aiApiKey` - API密钥
- ✅ `aiApiBaseUrl` - API地址
- ✅ `autoReply` - 自动回复开关
- ✅ `replyProbability` - 回复概率
- ✅ `replyInterval` - 回复间隔
- ✅ `listenInterval` - 监听间隔
- ✅ `bufferSize` - 缓冲消息数
- ✅ `enableImageRecognition` - 图片识别开关
- ✅ `proactiveEnabled` - 主动发言开关
- ✅ `proactiveIntervalMin/Max` - 主动发言间隔
- ✅ `proactivePrompt` - 主动发言提示词

**测试方法**：
```
1. 前端修改账号的"回复概率"从100%改为50%
2. 无需重启，下次回复时立即生效
```

---

### 2. 信息池配置（InfoSource & InfoItem）
**位置**：数据库 `InfoSource` 和 `InfoItem` 表  
**更新方式**：前端修改后立即生效  
**实现机制**：
- 每次 `fetchSource()` 时从数据库重新加载信息源配置
- 每次 `getAvailableItem()` 时从数据库查询最新的内容项

**支持热更新的字段**：
- ✅ `enabled` - 启用状态
- ✅ `fetchInterval` - 拉取间隔
- ✅ `expiryDuration` - 过期时间
- ✅ `workMode` - 工作方式（forward/opinion）
- ✅ `allowReuse` - 可复用
- ✅ `allowMultiUse` - 单号反复
- ✅ `historySize` - 历史堆栈大小（币价）
- ✅ `historyInterval` - 堆栈间隔（币价）

**测试方法**：
```
1. 前端修改信息源的"工作方式"从"直接转发"改为"输出观点"
2. 无需重启，下次主动发言时立即生效
```

---

### 3. 群组配置（Group）
**位置**：数据库 `Group` 表  
**更新方式**：前端修改后立即生效  
**实现机制**：
- 账号加载时会 `include: { targetGroup: true }`，获取最新的群组配置

**支持热更新的字段**：
- ✅ `language` - 群组语言（影响AI使用的默认提示词）

**测试方法**：
```
1. 前端修改群组语言从"中文"改为"English"
2. 无需重启，下次回复时AI会使用英文提示词
```

---

## ⚠️ 需要重启才能生效的配置

### 1. 默认提示词（prompts.ts）
**位置**：代码文件 `backend-playwright/src/config/prompts.ts`  
**原因**：静态导入的 TypeScript 文件，修改后需要重新编译和重启

**包含内容**：
- 中文/英文的 `systemPrompt`（基础性格和核心规则）
- 中文/英文的 `proactivePrompt`（主动发言风格）
- 中文/英文的 `imageCommentPrompt`（图片评论风格）
- 中文/英文的 `textCommentPrompt`（文本评论风格）

**影响范围**：
- 只影响**默认提示词**
- 账号的**补充提示词**（`systemPrompt` 字段）支持热更新

**变通方法**：
如果需要调整 AI 行为而不想重启服务，可以使用账号的"补充提示词"功能。

---

## 🔄 热更新的工作原理

### 账号配置热更新流程
```
用户在前端修改账号配置
    ↓
调用 API: PUT /api/v1/accounts/:id
    ↓
数据库更新 Account 记录
    ↓
下次 AI 处理消息时
    ↓
调用 reloadAccountConfig() 从数据库重新加载
    ↓
立即使用最新配置
```

### 信息池配置热更新流程
```
用户在前端修改信息源配置
    ↓
调用 API: PUT /api/v1/info-pool/sources/:id
    ↓
数据库更新 InfoSource 记录
    ↓
下次拉取或主动发言时
    ↓
从数据库重新查询信息源配置
    ↓
立即使用最新配置
```

---

## 📝 最佳实践

### 调整 AI 性格/行为
1. **快速调整**：使用账号的"补充提示词"（热更新）
2. **全局调整**：修改 `prompts.ts`（需重启）

### 调整信息池工作方式
1. 直接在前端修改信息源配置（热更新）
2. 无需任何重启操作

### 切换语言
1. 修改群组的"语言"设置（热更新）
2. AI 会自动使用对应语言的默认提示词

---

## 💡 示例场景

### 场景1：临时提高回复频率
```
问题：AI 回复太少了，想让它更活跃
解决：前端修改"回复概率"从 50% → 100%
结果：立即生效，无需重启
```

### 场景2：让某个账号更幽默
```
问题：想让某个账号说话更搞笑
解决：在该账号的"补充提示词"中填写：你说话很幽默，喜欢开玩笑，经常用"哈哈"
结果：立即生效，无需重启
```

### 场景3：信息源改为不可复用
```
问题：某个信息源的内容被反复使用
解决：前端取消"可复用"选项
结果：立即生效，该内容用过一次后不会再用
```

### 场景4：修改核心提示词规则
```
问题：想全局禁止 AI 使用某些词汇
解决：修改 prompts.ts，添加禁用规则
结果：需要重启后端服务才能生效
```

---

## 🚀 验证热更新是否生效

### 方法1：查看后端日志
修改配置后，观察后端控制台输出：
```
🎯 [AI] 使用默认提示词 + 账号补充提示词 (群组语言: zh-CN)
   补充内容: 你说话很幽默...
```

### 方法2：实际测试
1. 修改"回复概率"为 0%
2. 在群里发消息，AI 应该不再回复
3. 改回 100%
4. AI 恢复回复

---

## 📊 热更新支持情况汇总

| 配置项 | 位置 | 热更新 | 说明 |
|-------|------|--------|------|
| 账号配置 | 数据库 | ✅ 支持 | 包括提示词、模型、间隔等 |
| 信息池配置 | 数据库 | ✅ 支持 | 包括工作方式、间隔、过期时间等 |
| 群组语言 | 数据库 | ✅ 支持 | 影响使用的默认提示词语言 |
| 默认提示词 | 代码文件 | ❌ 需重启 | 修改后需重新编译和重启 |
| 预设币种列表 | 代码文件 | ❌ 需重启 | crypto-symbols.ts |

---

**总结**：99% 的日常配置调整都支持热更新，无需重启服务！ 🎉

